!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).Jsonic=e()}}((function(){var e={};Object.defineProperty(e,"__esModule",{value:!0}),e.util=e.RuleSpec=e.Parser=e.Lexer=e.JsonicError=e.Jsonic=void 0;const s=[],n={sc_space:" \t",sc_line:"\n\r",sc_number:"-0123456789",sc_string:"\"'`",sc_none:"",singles:"",escapes:{b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"},comments:{"#":!0,"//":!0,"/*":"*/"},balance:{comments:!0},number:{underscore:!0},string:{multiline:"`"},text:{hoover:!0},values:{null:null,true:!0,false:!1},digital:"-1023456789._xeEaAbBcCdDfF+",tokens:{value:s,ignore:s},bad_unicode_char:String.fromCharCode("0x0000"),console:console,error:{unknown:"Unknown error: $code"},OB:["#OB{"],CB:["#CB}"],OS:["#OS["],CS:["#CS]"],CL:["#CL:"],CA:["#CA,"],BD:["#BD"],ZZ:["#ZZ"],UK:["#UK"],CM:["#CM"],AA:["#AA"],SP:["#SP"],LN:["#LN"],NR:["#NR"],ST:["#ST"],TX:["#TX"],VL:["#VL"],LS_TOP:["@TOP"],LS_CONSUME:["@CONSUME"],LS_MULTILINE:["@MULTILINE"]};class t extends SyntaxError{constructor(e,s,n){s=p.deep({},s),n=p.deep({},n);let l=t.make_desc(e,s,n);super(l.message),Object.assign(this,l)}static make_desc(e,s,n){let t=s.token||s.e,l=n.opts,o=n.meta,r=[(l.error[e]||l.error.unknown).replace(/\$([\w_]+)/g,(r,i)=>(console.log("EM",r,i),"code"===i?e:s[i]||o[i]||t[i]||n[i]||l[i]||"$"+i)),"---",n.src()].join("\n"),i={internal:{token:t,ctx:n}};return{...Object.create(i),message:r,code:e,details:s,meta:o,fileName:o.fileName,lineNumber:t.row,columnNumber:t.col}}toJSON(){return{...this,__error:!0,name:this.name,message:this.message,stack:this.stack}}}e.JsonicError=t;class l{constructor(e){let s=this.options=e||p.deep({},n);this.end={pin:s.ZZ,loc:0,len:0,row:0,col:0,val:void 0,src:void 0},s.bad=function(e,n,t,l,o,r,i,c,a,p){return t.why=n,t.pin=s.BD,t.loc=o,t.row=r,t.col=i,t.len=o-l+1,t.val=c,t.src=a,t.use=p,e&&e(t.pin[0],t.src,{...t}),t}}start(e,s){const n=this.options;let t={pin:n.ZZ,loc:0,row:0,col:0,len:0,val:void 0,src:void 0},l=0,o=0,r=0,i=e.length,c=null!=s&&null!=s.log?(...e)=>s.log("lex",...e):void 0,a=function(){t.len=0,t.val=void 0,t.src=void 0,t.row=o;let s=n.LS_TOP,a=null,p="",u=0,d=[],f=-1;e:for(;l<i;){let h=e[l],S=e.charCodeAt(l);if(n.LS_TOP===s){if(n.SC_SPACE.includes(S)){for(t.pin=n.SP,t.loc=l,t.col=r++,u=l+1;n.sc_space.includes(e[u]);)r++,u++;return t.len=u-l,t.val=e.substring(l,u),t.src=t.val,l=u,c&&c(t.pin[0],t.src,{...t}),t}if(n.SC_LINE.includes(S)){for(t.pin=n.LN,t.loc=l,t.col=r,u=l,r=0;n.sc_line.includes(e[u]);)o+="\n"===e[u]?1:0,u++;return t.len=u-l,t.val=e.substring(l,u),t.src=t.val,l=u,c&&c(t.pin[0],t.src,{...t}),t}if(null!=n.SINGLES[S])return t.pin=n.SINGLES[S],t.loc=l,t.col=r++,t.len=1,t.src=h,l++,c&&c(t.pin[0],t.src,{...t}),t;if(n.SC_NUMBER.includes(S)){for(t.pin=n.NR,t.loc=l,t.col=r,u=l;n.DIGITAL.includes(e[++u]););if((null==e[u]||n.VALUE_ENDERS.includes(e[u]))&&(t.len=u-l,1<t.len&&"0"===e[l]&&"x"!=e[l+1]?(t.val=void 0,u--):(t.val=+e.substring(l,u),n.number.underscore&&isNaN(t.val)&&(t.val=+e.substring(l,u).replace(/_/g,"")),isNaN(t.val)&&(t.val=void 0,u--))),null!=t.val)return t.src=e.substring(l,u),r+=t.len,l=u,c&&c(t.pin[0],t.src,{...t}),t}else{if(n.SC_STRING.includes(S)){t.pin=n.ST,t.loc=l,t.col=r++;let s=h.charCodeAt(0),a=n.string.multiline.includes(h);for(d=[],f=-1,u=l+1;u<i;u++){if(r++,s===(f=e.charCodeAt(u))){u++;break}if(92===f){let s=e.charCodeAt(++u);r++;let i=n.ESCAPES[s];if(null!=i)d.push(i);else if(117===s){u++;let s=String.fromCharCode("0x"+e.substring(u,u+4));if(n.bad_unicode_char===s)return n.bad(c,"invalid-unicode",t,l,u,o,r,e.substring(u-2,u+4));d.push(s),u+=3,r+=4}else d.push(e[u])}else if(f<32){if(!a||!n.SC_LINE.includes(f))return n.bad(c,"unprintable",t,l,u,o,r,e.charAt(u));d.push(e[u])}else{let n=u;do{f=e.charCodeAt(++u),r++}while(32<=f&&s!==f&&92!==f);r--,d.push(e.substring(n,u)),u--}}return s!==f?(r=l,n.bad(c,"unterminated",t,l,u-1,o,r,d.join(""))):(t.val=d.join(""),t.src=e.substring(l,u),t.len=u-l,l=u,c&&c(t.pin[0],t.src,{...t}),t)}if(n.SC_COMMENT.includes(S)){let o=n.COMMENT_SINGLE.includes(h),i=e.substring(l,l+n.COMMENT_MARKER_MAXLEN);for(let e of n.COMMENT_MARKER)if(i.startsWith(e)){if(!0!==n.comments[e]){t.pin=n.CM,t.loc=l,t.col=r,t.val="",s=n.LS_MULTILINE,a=[e,n.comments[e],"comments"];continue e}o=!0;break}if(o){t.pin=n.CM,t.loc=l,t.col=r,t.val="",s=n.LS_CONSUME,p=n.sc_line;continue e}}}t.loc=l,t.col=r,u=l;do{r++,u++}while(null!=e[u]&&!n.VALUE_ENDERS.includes(e[u]));let C=e.substring(l,u),m=n.VALUES[C];if(void 0!==m)return t.pin=n.VL,t.val=m,t.src=C,t.len=u-l,l=u,c&&c(t.pin[0],t.src,{...t}),t;let _=n.text.hoover?n.HOOVER_ENDERS:n.TEXT_ENDERS;for(;null!=e[u]&&!_.includes(e[u]);)r++,u++;if(t.len=u-l,t.pin=n.TX,t.val=e.substring(l,u),t.src=t.val,n.text.hoover&&n.sc_space.includes(t.val[t.val.length-1])){let e=t.val.length-2;for(;0<e&&n.sc_space.includes(t.val[e]);)e--;t.val=t.val.substring(0,e+1),t.src=t.val,r-=t.len-e-1,t.len=t.val.length,l+=t.len}else l=u;return c&&c(t.pin[0],t.src,{...t}),t}if(n.LS_CONSUME===s){for(u=l;u<i&&!p.includes(e[u]);)u++,r++;return t.val+=e.substring(l,u),t.src=t.val,t.len=t.val.length,l=u,s=n.LS_TOP,c&&c(t.pin[0],t.src,{...t}),t}if(n.LS_MULTILINE===s){u=l;let o=1,r=a[0],p=a[1],d=n.balance[a[2]],f=r.length,h=p.length;for(u+=r.length;u<i&&0<o;)p[0]===e[u]&&p===e.substring(u,u+h)?(u+=h,o--):d&&r[0]===e[u]&&r===e.substring(u,u+f)?(u+=f,o++):u++;return t.val=e.substring(l,u),t.src=t.val,t.len=t.val.length,l=u,s=n.LS_TOP,c&&c(t.pin[0],t.src,{...t}),t}}return t.pin=n.ZZ,t.loc=i,t.col=r,c&&c(t.pin[0],t.src,{...t}),t};return a.src=e,a}}var o;e.Lexer=l,function(e){e[e.open=0]="open",e[e.close=1]="close"}(o||(o={}));class r{constructor(e,s,n,t){this.id=s.rI++,this.name=e.name,this.spec=e,this.node=t,this.ctx=s,this.opts=n,this.state=o.open,this.child=i,this.open=[],this.close=[]}process(e){let s=i;return o.open===this.state?s=this.spec.open(this,e):o.close===this.state&&(s=this.spec.close(this,e)),s}toString(){return JSON.stringify(this.spec)}}let i={id:0,spec:{name:"norule"}};class c{constructor(e,s,n){this.name=e,this.def=s,this.rm=n}open(e,s){let n=e;if(this.def.before_open){let s=this.def.before_open.call(this,e);e.node=s.node||e.node}let l=this.parse_alts(this.def.open,e,s);if(l.e)throw new t("unexpected-token",{...l},s);return e.open=l.m,l.p?(s.rs.push(e),n=e.child=new r(this.rm[l.p],s,e.opts,e.node)):l.r&&(n=new r(this.rm[l.r],s,e.opts,e.node)),this.def.after_open&&this.def.after_open.call(this,e,n),s.log&&s.log("node",e.name+"/"+e.id,o[e.state],e.node),e.state=o.close,n}close(e,s){let n=i,t="s";this.def.before_close&&this.def.before_close.call(this,e);let l=0<this.def.close.length?this.parse_alts(this.def.close,e,s):{};if(l.e)throw new Error("unexpected token: "+l.e.pin[0]+" "+l.e.val);return l.h&&(n=l.h(this,e,s)||n),l.p?(s.rs.push(e),n=e.child=new r(this.rm[l.p],s,e.opts,e.node)):l.r?(n=new r(this.rm[l.r],s,e.opts,e.node),t="r"):(n=s.rs.pop()||i,t="p"),this.def.after_close&&this.def.after_close.call(this,e,n),s.log&&s.log("node",e.name+"/"+e.id,o[e.state],e.node),n}parse_alts(e,s,n){let t,l=void 0;if(n.opts.ZZ===n.t0.pin)l={m:[]};else if(0<e.length){for(t of e)if(!t.c||t.c(t,n)){if(null==t.s||0===t.s.length){l={...t,m:[]};break}if(t.s[0]===n.t0.pin){if(1===t.s.length){l={...t,m:[n.t0]};break}if(t.s[1]===n.t1.pin){l={...t,m:[n.t0,n.t1]};break}}else if(n.opts.AA===t.s[0]){l={...t,m:[n.t0]};break}}l=l||{e:n.t0,m:[]}}if(l=l||{m:[]},n.log&&n.log("parse",s.name+"/"+s.id,o[s.state],"alts",t&&t.s?t.s.join(""):"",n.tI,"p="+(l.p||""),"r="+(l.r||""),"b="+(l.b||""),l.m.map(e=>e.pin).join(" "),l.m.map(e=>e.src).join(""),l),l.m){let e=0,s=l.m.length-(l.b||0);for(;e++<s;)n.next()}return l}}e.RuleSpec=c;class a{constructor(e){let s=this.options=e||p.deep({},n);this.rules={val:{open:[{s:[s.OB],p:"map"},{s:[s.OS],p:"list"},{s:[s.CA],p:"list",b:1},{s:[s.TX,s.CL],p:"map",b:2},{s:[s.ST,s.CL],p:"map",b:2},{s:[s.NR,s.CL],p:"map",b:2},{s:[s.VL,s.CL],p:"map",b:2},{s:[s.TX]},{s:[s.NR]},{s:[s.ST]},{s:[s.VL]}],close:[{s:[s.CA],c:(e,s)=>0===s.rs.length,r:"elem",h:(e,s,n)=>{s.node=[s.node]}},{s:[s.AA],b:1}],before_close:e=>{var s,n;e.node=null!==(s=e.child.node)&&void 0!==s?s:null===(n=e.open[0])||void 0===n?void 0:n.val}},map:{before_open:()=>({node:{}}),open:[{s:[s.CB]},{p:"pair"}],close:[]},list:{before_open:()=>({node:[]}),open:[{s:[s.CS]},{p:"elem"}],close:[]},pair:{open:[{s:[s.ST,s.CL],p:"val"},{s:[s.TX,s.CL],p:"val"},{s:[s.NR,s.CL],p:"val"},{s:[s.VL,s.CL],p:"val"},{s:[s.CB],b:1}],close:[{s:[s.CA],r:"pair"},{s:[s.CB]},{s:[s.ST,s.CL],r:"pair",b:2},{s:[s.TX,s.CL],r:"pair",b:2},{s:[s.NR,s.CL],r:"pair",b:2},{s:[s.VL,s.CL],r:"pair",b:2}],before_close:e=>{let n=e.open[0];if(n){let t=s.ST===n.pin?n.val:n.src;e.node[t]=e.child.node}}},elem:{open:[{s:[s.OB],p:"map"},{s:[s.OS],p:"list"},{s:[s.TX]},{s:[s.NR]},{s:[s.ST]},{s:[s.VL]},{s:[s.CA,s.CA],b:2},{s:[s.CA]}],close:[{s:[s.CA,s.CS]},{s:[s.CA],r:"elem"},{s:[s.CS]},{s:[s.OB],p:"map"},{s:[s.OS],p:"list"},{s:[s.TX,s.CL],p:"map",b:2},{s:[s.NR,s.CL],p:"map",b:2},{s:[s.ST,s.CL],p:"map",b:2},{s:[s.VL,s.CL],p:"map",b:2},{s:[s.TX],r:"elem",b:1},{s:[s.NR],r:"elem",b:1},{s:[s.ST],r:"elem",b:1},{s:[s.VL],r:"elem",b:1}],after_open:(e,s)=>{if(e===s&&e.open[0]){let s=e.open[0].val;e.node.push(null!=s?s:null)}},before_close:e=>{e.child.node&&e.node.push(e.child.node)}}},this.rulespecs=Object.keys(this.rules).reduce((e,s)=>(e[s]=new c(s,this.rules[s],e),e),{})}rule(e,s){this.rulespecs[e]=s(this.rulespecs[e])||this.rulespecs[e]}start(e,s,n){let t=this.options,l={rI:1,opts:t,meta:n||{},src:()=>s,node:void 0,t0:t.end,t1:t.end,tI:-2,next:d,rs:[],log:n&&n.log||void 0};if("number"==typeof l.log){let e=!1,s=l.log;-1===s&&(s=1,e=!0),l.log=(...n)=>{if(e){let e=n.filter(e=>"object"!=typeof e).join("\t");"node"===n[0]&&(e+="\t"+JSON.stringify(n[3])),t.console.log(e)}else t.console.dir(n,{depth:s})}}let c=e.start(s,l),a=new r(this.rulespecs.val,l,t),p=a,u=2*Object.keys(this.rulespecs).length*c.src.length;function d(){let e;l.t0=l.t1;do{e=c(),l.tI++}while(t.tokens.ignore.includes(e.pin));return l.t1={...e},l.t0}d(),d();let f=0;for(;i!==a&&f<u;)l.log&&l.log("rule",a.name+"/"+a.id,o[a.state],l.rs.length,l.tI,l.t0.pin+" "+l.t1.pin,a,l),a=a.process(l),l.log&&l.log("stack",l.rs.map(e=>e.name+"/"+e.id).join(";"),a,l),f++;return p.node}}e.Parser=a;let p={deep:function(e,s){if(null!=e&&null!=s){for(let n in s)e[n]="object"==typeof e[n]&&"object"==typeof s[n]&&Array.isArray(e[n])===Array.isArray(s[n])?p.deep(e[n],s[n]):s[n];return e}return null!=s?s:null!=e?e:null!=s?s:e},s2cca:function(e){return e.split("").map(e=>e.charCodeAt(0))},longest:e=>e.reduce((e,s)=>e<s.length?s.length:e,0),norm_options:function(e){let n=Object.keys(e);if(n.filter(e=>e.startsWith("sc_")).forEach(s=>{e[s.toUpperCase()]=p.s2cca(e[s])}),e.SINGLES=n.filter(s=>2===s.length&&Array.isArray(e[s])&&"#"===e[s][0][0]&&4===e[s][0].length).reduce((s,n)=>(s[e[n][0].charCodeAt(3)]=e[n],s),[]),e.singles=null==e.singles?"":e.singles,e.singles.split("").forEach((s,n)=>{e.SINGLES[s.charCodeAt(0)]=["#"+s+"#"+n]}),e.TOKENS=e.SINGLES.map((e,s)=>null==e?null:s).filter(e=>null!=+e).reduce((s,n)=>(s[String.fromCharCode(n)]=e.SINGLES[n],s),{}),e.escapes=e.escapes||{},e.ESCAPES=Object.keys(e.escapes).reduce((s,n)=>(s[n.charCodeAt(0)]=e.escapes[n],s),[]),e.DIGITAL=e.digital||"",e.SC_COMMENT=[],e.COMMENT_SINGLE="",e.COMMENT_MARKER=[],e.comments){let s=Object.keys(e.comments);s.forEach(s=>{1===s.length?(e.SC_COMMENT.push(s.charCodeAt(0)),e.COMMENT_SINGLE+=s):(e.SC_COMMENT.push(s.charCodeAt(0)),e.COMMENT_MARKER.push(s))}),e.COMMENT_MARKER_MAXLEN=p.longest(s)}return e.SC_COMMENT_CHARS=e.SC_COMMENT.map(e=>String.fromCharCode(e)).join(""),e.SINGLE_CHARS=e.SINGLES.map((e,s)=>String.fromCharCode(s)).join(""),e.VALUE_ENDERS=e.sc_space+e.sc_line+e.SINGLE_CHARS+e.SC_COMMENT_CHARS,e.TEXT_ENDERS=e.VALUE_ENDERS,e.HOOVER_ENDERS=e.sc_line+e.SINGLE_CHARS+e.SC_COMMENT_CHARS,e.VALUES=e.values||{},e.tokens=e.tokens||{},e.tokens.value=s!==e.tokens.value?e.tokens.value:[e.TX,e.NR,e.ST,e.VL],e.tokens.ignore=s!==e.tokens.ignore?e.tokens.ignore:[e.SP,e.LN,e.CM],e}};e.util=p;let u=function e(s,t){let o=s;"function"==typeof s&&(o={},t=s);let r=p.deep(p.deep({},t?t.options:n),o);r=p.norm_options(r);let i=function(e,s){return"string"==typeof e?i._parser.start(i._lexer,e,s):e};if(t){for(let e in t)i[e]=t[e];i.parent=t}return i._lexer=new l(r),i._parser=new a(r),i.options=p.deep(e=>{if(null!=e&&"object"==typeof e){r=p.norm_options(p.deep(r,e));for(let e in r)i.options[e]=r[e]}},r),i.parse=i,i.use=function(e){e(i)},i.rule=function(e,s){i._parser.rule(e,s)},i.make=function(s){return e(s,i)},i}();return e.Jsonic=u,e}));